- name: Install required packages git, vim, libgit2-dev
  apt:
    name: [ git, vim, libgit2-dev, libgit2-28, lxc-dev, sendmail ]
    state: present
  become: yes

- name: Create electricbook user
  user: >
    name=electricbook
    shell=/bin/bash
    
  become: yes
  # groups='rvm,'
- name: install
  tags: ['bin','public']
  git: 
    repo: "{{git_repo}}"
    dest: /opt/electricbook
  become: yes

- name: Set permissions on git_cache
  tags: ['bin']
  file: >
    name="{{git_cache}}"
    owner=electricbook
    group=electricbook
    state=directory
    recurse=yes
  become: yes

- name: Create /opt/electricbook/bin
  file: >
    name=/opt/electricbook/bin
    state=directory
    mode=0755
  become: yes

- name: install electricbook
  tags: ['bin']
  copy: >
    dest=/opt/electricbook/bin/electricbook
    force=yes
    src=electricbook
    mode=0755
  become: yes 
  notify: "restart electricbook"

- name: install-config
  template: >
    dest=/opt/electricbook/electricbook-0.yml
    src=electricbook-0.yml.j2
    mode=0755
  become: yes
  notify: "restart electricbook"

- name: install-allowed-users
  become: yes
  become_method: sudo
  copy:
    src: ../../../../../electricbook-users.txt
    dest: /opt/electricbook
    force: yes
    mode: "0644"
  notify: restart electricbook

- name: configure upstart for electricbook
  when: >
    ansible_distribution_major_version|int < 16
  template: >
    src=upstart.electricbook.conf.j2
    dest=/etc/init/electricbook.conf
  become: yes
  become_method: sudo
  notify: "restart electricbook"

- name: configure systemd for electricbook
  when: >
    ansible_distribution_major_version|int >= 16
  include: systemd.yml
  notify: "restart electricbook"

- include: nginx.yml
  when: >
    'nginx'==webserver


- name: install-libgit2
  become: yes
  script: install-libgit2.sh
  # when: >
  #   ansible_distribution_major_version|int < 20

- name: install-electricbook-ruby-and-node
  become: yes
  become_method: sudo
  command:
    chdir: /opt/electricbook
    cmd: "/opt/electricbook/bin/electricbook {{item}} --owner electricbook --group electricbook"
  with_items: ['install-ruby','install-node']

